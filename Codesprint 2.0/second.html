<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kishan Mitra ‚Äî Crop Advisor</title>
  <style>
    :root{
      --bg:#f7fff0;
      --card:#ffffff;
      --accent1:#2e8b57; /* crop green */
      --accent2:#f6c85f; /* crop yellow */
      --accent3:#8fbfe0; /* sky */
      --muted:#6b6b6b;
      --glass: rgba(255,255,255,0.8);
      --glass-2: rgba(255,255,255,0.6);
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(135deg,var(--bg),#e8fff4);color:#123;}
    .app{max-width:1100px;margin:28px auto;padding:24px}
    header{display:flex;align-items:center;gap:16px}
    .logo{display:flex;align-items:center;gap:12px}
    .logo .mark{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:20px;box-shadow:0 6px 18px rgba(46,139,87,0.2)}
    h1{margin:0;font-size:20px}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    .grid{display:grid;grid-template-columns:380px 1fr;gap:20px;margin-top:20px}

    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 20px rgba(18,35,25,0.06)}
    .controls label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    .controls select,.controls input{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6;font-size:14px}
    .row{display:flex;gap:12px}
    .half{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white;font-weight:600;cursor:pointer}
    .btn.secondary{background:transparent;border:1px solid var(--accent1);color:var(--accent1)}

    .results{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:14px}
    .resultCard{padding:12px;border-radius:10px;background:linear-gradient(180deg,var(--glass),var(--glass-2));border:1px solid rgba(0,0,0,0.04)}
    .resultCard h3{margin:0 0 8px 0}
    .muted{color:var(--muted);font-size:13px}

    .recommendList{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px}
    .recommendList li{padding:10px;border-radius:8px;background:#fffef7;border-left:4px solid var(--accent2)}

    footer{margin-top:18px;color:var(--muted);font-size:13px}

    @media (max-width:900px){.grid{grid-template-columns:1fr;}.results{grid-template-columns:1fr}}

    .chip{display:inline-block;padding:6px 8px;border-radius:999px;background:linear-gradient(90deg,var(--accent3),var(--accent1));color:white;font-weight:600;font-size:12px}

    .kpi{display:flex;gap:12px;align-items:center}
    .kpi .item{flex:1;padding:12px;border-radius:10px;background:linear-gradient(180deg,#ffffff,#f7fff0);}
    .kpi .value{font-weight:700;font-size:18px}

    /* floating mic button */
    .mic-btn{position:fixed;bottom:20px;right:20px;z-index:999;width:64px;height:64px;border-radius:50%;
      background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;
      color:white;font-size:28px;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,0.2);}
    .mic-btn.active{animation:pulse 1.6s infinite}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}

    .voice-status{position:fixed;bottom:100px;right:20px;background:rgba(255,255,255,0.95);padding:8px 12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.08);font-size:14px;color:#234;}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">
        <div class="mark">KM</div>
        <div>
          <h1>Kishan Mitra</h1>
          <p class="lead">AI-driven crop recommendations ‚Ä¢ Multilingual Voice Assistant ‚Ä¢ Real-time soil sensing</p>
        </div>
      </div>
      <div style="margin-left:auto" class="chip">Prototype</div>
    </header>

    <div class="grid">
      <!-- left: controls -->
      <div>
        <div class="card controls">
          <h2 style="margin-top:0">Crop & Soil Inputs</h2>
          <div style="margin-top:10px">
            <label>State</label>
            <select id="stateSelect"></select>
          </div>
          <div style="margin-top:10px">
            <label>District</label>
            <select id="districtSelect"></select>
          </div>
          <div style="margin-top:10px">
            <label>Month</label>
            <select id="monthSelect"></select>
          </div>

          <div style="margin-top:12px" class="row">
            <div class="half">
              <label>N (Nitrogen) - kg/ha</label>
              <input id="nVal" type="number" value="80" />
            </div>
            <div class="half">
              <label>P (Phosphorous) - kg/ha</label>
              <input id="pVal" type="number" value="30" />
            </div>
          </div>
          <div style="margin-top:12px" class="row">
            <div class="half">
              <label>K (Potassium) - kg/ha</label>
              <input id="kVal" type="number" value="40" />
            </div>
            <div class="half">
              <label>Soil pH</label>
              <input id="phVal" type="number" step="0.1" value="6.5" />
            </div>
          </div>

          <div style="margin-top:14px;display:flex;gap:10px;align-items:center">
            <button class="btn" id="analyzeBtn">Analyze & Recommend</button>
            <button class="btn secondary" id="clearBtn">Reset</button>
          </div>

          <hr style="margin:14px 0;border:none;border-top:1px dashed #eee">

          <label>Voice Language</label>
          <select id="langSelect" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6;margin-top:6px">
            <option value="hi-IN" selected>‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</option>
            <option value="en-IN">English (India)</option>
            <option value="mr-IN">‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)</option>
            <option value="ta-IN">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
            <option value="te-IN">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</option>
            <option value="bn-IN">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)</option>
            <option value="kn-IN">‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)</option>
          </select>

          <div style="margin-top:10px;color:var(--muted);font-size:13px">
            Tip: Tap the mic (bottom-right), speak in your local language. Say numeric values (e.g., ‚Äú‡§®‡§æ‡§á‡§ü‡•ç‡§∞‡•ã‡§ú‡§® 40, ‡§´‡•â‡§∏‡•ç‡§´‡•ã‡§∞‡§∏ 20, ‡§™‡•ã‡§ü‡§æ‡§∂ 30, ‡§™‡•Ä‡§è‡§ö 6.5‚Äù) or ask ‚Äú‡§ï‡•å‡§® ‡§∏‡•Ä ‡§´‡§∏‡§≤?‚Äù to analyze.
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin:0">Quick Tips</h3>
          <ul style="margin-top:8px;color:var(--muted);font-size:13px">
            <li>Use local language for better recognition.</li>
            <li>Ensure sensor is placed 10‚Äì15 cm deep for accurate readings.</li>
            <li>Adjust NPK values based on crop lifecycle stage.</li>
          </ul>
        </div>

      </div>

      <!-- right: results -->
      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
            <div>
              <h2 style="margin:0">Recommendations</h2>
              <div class="muted">Predicted best crops, composts & pest control</div>
            </div>
            <div style="text-align:right">
              <div class="muted">Farm Score</div>
              <div style="font-size:22px;font-weight:800;color:var(--accent1)" id="farmScore">‚Äî</div>
            </div>
          </div>

          <div class="results" id="resultsArea">
            <div class="resultCard">
              <h3>Top Crops</h3>
              <div class="muted">Crops suited for selected region & soil</div>
              <ul id="cropList" style="margin-top:10px"></ul>
            </div>
            <div class="resultCard">
              <h3>Soil & Weather Snapshot</h3>
              <div class="muted">Latest sensor + typical month data</div>
              <div style="margin-top:10px" id="snapshot"></div>
            </div>
            <div class="resultCard">
              <h3>Compost Suggestions</h3>
              <ul id="compostList" class="recommendList"></ul>
            </div>
            <div class="resultCard">
              <h3>Pest & Disease</h3>
              <ul id="pestList" class="recommendList"></ul>
            </div>
          </div>

        </div>

        <div class="card" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 style="margin:0">Summary</h3>
            <div class="muted">One-line advice</div>
          </div>
          <div id="oneLine" style="margin-top:10px;font-weight:700;font-size:16px">‚Äî</div>

          <div class="kpi" style="margin-top:12px">
            <div class="item"><div class="muted">Expected Yield Uplift</div><div class="value" id="uplift">‚Äî</div></div>
            <div class="item"><div class="muted">Water Saving</div><div class="value" id="waterSave">‚Äî</div></div>
          </div>
        </div>

      </div>
    </div>

    <footer>
      Built with ‚ù§Ô∏è for farmers ‚Ä¢ Kishan Mitra prototype ‚Ä¢ Voice features depend on browser support
    </footer>
  </div>

  <!-- floating mic + status -->
  <div class="mic-btn" id="micBtn" title="Tap to speak">üéôÔ∏è</div>
  <div class="voice-status" id="voiceStatus" aria-live="polite">Idle</div>

  <script>
    /* ============================
       Data & DOM references
       ============================ */
    const STATES = {
      "Andhra Pradesh": ["Anantapur", "Chittoor", "Guntur", "Krishna", "Visakhapatnam"],
      "Bihar": ["Patna", "Gaya", "Bhagalpur", "Muzaffarpur", "Darbhanga"],
      "Delhi": ["New Delhi", "North Delhi", "South Delhi", "East Delhi", "West Delhi"],
      "Maharashtra": ["Mumbai", "Pune", "Nagpur", "Nashik", "Aurangabad"],
      "Tamil Nadu": ["Chennai", "Madurai", "Coimbatore", "Salem", "Tiruchirappalli"],
      "Uttar Pradesh": ["Lucknow", "Kanpur", "Varanasi", "Agra", "Allahabad"],
      "West Bengal": ["Kolkata", "Howrah", "Darjeeling", "Asansol", "Durgapur"]
    };

    const CROPS = [
      {id:'sugarcane',name:'Sugarcane',months:[6,7,8,9,10],rain:[600,2000],N:[100,200],P:[30,80],K:[60,120],pH:[5.5,8]},
      {id:'rice',name:'Rice',months:[6,7,8,9],rain:[800,2000],N:[80,160],P:[30,60],K:[40,120],pH:[5,6.8]},
      {id:'maize',name:'Maize',months:[6,7,8,9],rain:[200,1000],N:[60,140],P:[20,60],K:[20,80],pH:[5.5,7.5]},
      {id:'groundnut',name:'Groundnut',months:[7,8,9,10],rain:[400,1200],N:[20,60],P:[20,60],K:[20,80],pH:[5.5,7.0]},
      {id:'wheat',name:'Wheat',months:[11,12,1,2,3],rain:[200,600],N:[60,120],P:[30,70],K:[20,60],pH:[6.0,7.5]}
    ];

    const COMPOSTS = {
      'rice': ['Green manure (Sesbania)', 'Compost + Azolla', 'Farmyard manure'],
      'maize': ['Compost enriched with Neem cake', 'Vermicompost'],
      'wheat': ['N-rich FYM', 'Composted manure'],
      'sugarcane': ['Pressmud compost', 'Vermicompost'],
      'groundnut': ['Biochar enriched compost', 'Vermicompost']
    };

    const PESTS = {
      'rice': ['Use Trichogramma parasitoids', 'Neem oil spray (biopesticide)'],
      'maize': ['Pheromone traps', 'Crop rotation & biopesticides'],
      'wheat': ['Monitor for rust - apply recommended fungicide', 'Use resistant varieties'],
      'sugarcane': ['Integrated pest management, Topical biopesticides'],
      'groundnut': ['Use seed treatment with Trichoderma', 'Timely weeding']
    };

    const WEATHER = {
      'Pune':{rain:650,temp:24},'Nagpur':{rain:1200,temp:26},'Nashik':{rain:700,temp:25},
      'Bengaluru Urban':{rain:900,temp:23},'Mysore':{rain:750,temp:25},'Belgaum':{rain:1100,temp:24},
      'Chennai':{rain:1000,temp:29},'Coimbatore':{rain:800,temp:26},'Madurai':{rain:650,temp:28}
    };

    // dom
    const stateSelect = document.getElementById('stateSelect');
    const districtSelect = document.getElementById('districtSelect');
    const monthSelect = document.getElementById('monthSelect');
    const nVal = document.getElementById('nVal');
    const pVal = document.getElementById('pVal');
    const kVal = document.getElementById('kVal');
    const phVal = document.getElementById('phVal');

    const analyzeBtn = document.getElementById('analyzeBtn');
    const clearBtn = document.getElementById('clearBtn');
    const langSelect = document.getElementById('langSelect');

    const cropList = document.getElementById('cropList');
    const compostList = document.getElementById('compostList');
    const pestList = document.getElementById('pestList');
    const snapshot = document.getElementById('snapshot');
    const farmScore = document.getElementById('farmScore');
    const oneLine = document.getElementById('oneLine');
    const upliftEl = document.getElementById('uplift');
    const waterSaveEl = document.getElementById('waterSave');

    const micBtn = document.getElementById('micBtn');
    const voiceStatusEl = document.getElementById('voiceStatus');

    /* ============================
       Populate selects
       ============================ */
    Object.keys(STATES).forEach(s=>{
      const o = document.createElement('option'); o.value = s; o.textContent = s; stateSelect.appendChild(o);
    });

    function populateDistricts(){
      districtSelect.innerHTML = '';
      const s = stateSelect.value || Object.keys(STATES)[0];
      (STATES[s] || []).forEach(d => { const o = document.createElement('option'); o.value = d; o.textContent = d; districtSelect.appendChild(o); });
    }
    stateSelect.addEventListener('change', populateDistricts);

    for(let m=1;m<=12;m++){ const o=document.createElement('option'); o.value=m; o.textContent=new Date(0,m-1).toLocaleString('en',{month:'long'}); monthSelect.appendChild(o); }
    populateDistricts();

    analyzeBtn.addEventListener('click', analyze);
    clearBtn.addEventListener('click', ()=>{ nVal.value=80; pVal.value=30; kVal.value=40; phVal.value=6.5; });

    /* ============================
       Analysis logic (same scoring)
       ============================ */
    function analyze(){
      const state = stateSelect.value; const district = districtSelect.value; const month = +monthSelect.value;
      const N = +nVal.value, P = +pVal.value, K = +kVal.value, ph = +phVal.value;
      const w = WEATHER[district] || {rain:600,temp:25};

      const scored = CROPS.map(c=>{
        let score=0;
        if(c.months.includes(month)) score+=30;
        const rainAvg = w.rain; const rMid = (c.rain[0]+c.rain[1])/2;
        const rainScore = Math.max(0,30 - Math.abs(rMid - rainAvg)/10);
        score+=rainScore;
        const nScore = Math.max(0,20 - Math.abs(((c.N[0]+c.N[1])/2) - N)/5);
        const pScore = Math.max(0,10 - Math.abs(((c.P[0]+c.P[1])/2) - P)/3);
        const kScore = Math.max(0,10 - Math.abs(((c.K[0]+c.K[1])/2) - K)/4);
        score += nScore + pScore + kScore;
        const phPref = (c.pH[0] + c.pH[1]) / 2;
        const phScore = Math.max(0,10 - Math.abs(phPref - ph)*4);
        score += phScore;
        return {...c, score: Math.round(score)};
      }).sort((a,b)=>b.score-a.score);

      // show top 3
      cropList.innerHTML=''; scored.slice(0,3).forEach(c=>{
        const li = document.createElement('li');
        li.style.padding='8px'; li.style.borderRadius='8px'; li.style.background='#f7fff6'; li.style.marginBottom='6px';
        li.innerHTML = `<strong>${c.name}</strong> <div class='muted'>Match score: ${c.score}</div>`;
        cropList.appendChild(li);
      });

      // compost & pests for top crop
      compostList.innerHTML=''; pestList.innerHTML='';
      const top = scored[0];
      (COMPOSTS[top.id] || []).forEach(it => { const li = document.createElement('li'); li.textContent=it; compostList.appendChild(li); });
      (PESTS[top.id] || []).forEach(it => { const li = document.createElement('li'); li.textContent=it; pestList.appendChild(li); });

      snapshot.innerHTML = `<div><strong>District:</strong> ${district} ‚Ä¢ <strong>State:</strong> ${state}</div>
        <div class='muted'>Avg Rain: ${w.rain} mm ‚Ä¢ Avg Temp: ${w.temp}¬∞C</div>
        <div class='muted'>Soil: N=${N} P=${P} K=${K} ‚Ä¢ pH=${ph}</div>`;

      farmScore.textContent = scored[0].score + '/110';
      oneLine.textContent = `Best: ${scored[0].name}. Suggest: ${COMPOSTS[scored[0].id]?.[0] || 'Standard compost'}. Use biopesticides if needed.`;

      upliftEl.textContent = (5 + Math.round(scored[0].score/11)) + '%';
      waterSaveEl.textContent = Math.max(5, Math.round((scored[0].score/110)*20)) + '%';

      // speak result summary
      const compostTxt = (COMPOSTS[top.id] && COMPOSTS[top.id][0]) ? COMPOSTS[top.id][0] : 'farmyard manure';
      const pestTxt = (PESTS[top.id] && PESTS[top.id][0]) ? PESTS[top.id][0] : 'monitor pests';
      speakText(`${top.name} is recommended. Compost suggestion: ${compostTxt}. Pest tip: ${pestTxt}.`);
    }

    /* ============================
       Voice assistant (ASR + TTS)
       ============================ */
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;
    let recognition = null;
    let isListening = false;

    function devToLatinDigits(str){
      // convert Devanagari digits to latin digits (‡•¶-‡•Ø)
      return str.replace(/[\u0966-\u096F]/g, ch => String(ch.charCodeAt(0) - 0x0966));
    }

    function extractNumbersFromText(text){
      const t = devToLatinDigits(text);
      const nums = t.match(/\d+(\.\d+)?/g);
      return nums ? nums.map(n => parseFloat(n)) : [];
    }

    function findMonthFromText(text){
      // map of common month names in Hindi & English
      const map = {
        'january':1,'‡§ú‡§®‡§µ‡§∞‡•Ä':1,'february':2,'‡§´‡§∞‡§µ‡§∞‡•Ä':2,'march':3,'‡§Æ‡§æ‡§∞‡•ç‡§ö':3,'april':4,'‡§Ö‡§™‡•ç‡§∞‡•à‡§≤':4,
        'may':5,'‡§Æ‡§à':5,'june':6,'‡§ú‡•Ç‡§®':6,'july':7,'‡§ú‡•Å‡§≤‡§æ‡§à':7,'august':8,'‡§Ö‡§ó‡§∏‡•ç‡§§':8,
        'september':9,'‡§∏‡§ø‡§§‡§Ç‡§¨‡§∞':9,'october':10,'‡§Ö‡§ï‡•ç‡§ü‡•Ç‡§¨‡§∞':10,'november':11,'‡§®‡§µ‡§Ç‡§¨‡§∞':11,
        'december':12,'‡§¶‡§ø‡§∏‡§Ç‡§¨‡§∞':12
      };
      for(const k in map){ if(text.includes(k)) return map[k]; }
      // also allow numeric month words like '6', '‡•¨'
      const num = extractNumbersFromText(text)[0];
      if(num && num>=1 && num<=12) return Math.round(num);
      return null;
    }

    function matchStateDistrictFromText(text){
      // try to match state or district by substring (lowercased)
      const t = text.toLowerCase();
      // states
      for(const st of Object.keys(STATES)){
        if(t.includes(st.toLowerCase())) return {state: st};
      }
      // districts
      for(const st of Object.keys(STATES)){
        for(const d of STATES[st]){
          if(t.includes(d.toLowerCase())) return {state: st, district: d};
        }
      }
      return {};
    }

    function speakText(txt){
      const lang = langSelect.value || 'hi-IN';
      if('speechSynthesis' in window){
        const utter = new SpeechSynthesisUtterance(txt);
        utter.lang = lang;
        // try to pick a voice that matches the selected language
        const voices = speechSynthesis.getVoices();
        if(voices && voices.length){
          // pick voice that starts with language code (e.g., 'hi' for hi-IN) else fallback to first voice
          const langPrefix = lang.split('-')[0];
          const v = voices.find(v => v.lang && v.lang.toLowerCase().startsWith(langPrefix)) || voices.find(v=>v.lang && v.lang.toLowerCase().startsWith(lang)) || voices[0];
          if(v) utter.voice = v;
        }
        speechSynthesis.cancel();
        speechSynthesis.speak(utter);
      } else {
        console.log('TTS not supported');
      }
    }

    // Initialize recognition if available
    if(SpeechRecognition){
      recognition = new SpeechRecognition();
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.lang = langSelect.value || 'hi-IN';

      recognition.onstart = () => { isListening = true; micBtn.classList.add('active'); voiceStatusEl.textContent = 'Listening...'; }
      recognition.onend = () => { isListening = false; micBtn.classList.remove('active'); if(voiceStatusEl.textContent === 'Listening...') voiceStatusEl.textContent = 'Idle'; }
      recognition.onerror = (e) => { isListening = false; micBtn.classList.remove('active'); voiceStatusEl.textContent = 'Speech error: ' + (e.error || e.message || 'unknown'); }

      recognition.onresult = (e) => {
        const textRaw = e.results[0][0].transcript;
        voiceStatusEl.textContent = 'Heard: ' + textRaw;
        processVoiceCommand(textRaw);
      };
    } else {
      micBtn.style.opacity = 0.5; micBtn.title = 'Speech recognition not supported';
      voiceStatusEl.textContent = 'Speech API not supported in this browser';
    }

    // change recognition language when user picks a different voice lang
    langSelect.addEventListener('change', ()=>{
      if(recognition) recognition.lang = langSelect.value || 'hi-IN';
      speakText(langSelect.options[langSelect.selectedIndex].text + ' voice selected');
    });

    // mic toggle
    micBtn.addEventListener('click', ()=>{
      if(!recognition) { speakText('Speech recognition not supported on this browser. Use Chrome.'); return; }
      if(!isListening){ try { recognition.start(); } catch(e){ console.warn(e); } }
      else recognition.stop();
    });

    /* ============================
       Process spoken text -> autofill & commands
       ============================ */
    function processVoiceCommand(text){
      const lower = text.toLowerCase();
      const nums = extractNumbersFromText(lower); // array of numbers converted to latin digits

      // try match state/district
      const matched = matchStateDistrictFromText(lower);
      if(matched.state){
        stateSelect.value = matched.state;
        populateDistricts();
        if(matched.district) districtSelect.value = matched.district;
      }

      // month
      const monthNum = findMonthFromText(lower);
      if(monthNum) monthSelect.value = monthNum;

      // If user spoke 4+ numbers, assume N P K pH order
      if(nums.length >= 4){
        nVal.value = nums[0];
        pVal.value = nums[1];
        kVal.value = nums[2];
        phVal.value = nums[3];
        voiceStatusEl.textContent = 'Values set from voice';
        speakText('‡§Æ‡§æ‡§® ‡§∏‡•á‡§ü ‡§ï‡§∞ ‡§¶‡§ø‡§è ‡§ó‡§è ‡§π‡•à‡§Ç‡•§ ‡§Ø‡§¶‡§ø ‡§Ü‡§™ ‡§ö‡§æ‡§π‡§ø‡§è ‡§§‡•ã "‡§∏‡•Å‡§ù‡§æ‡§µ" ‡§ï‡§π‡•á‡§Ç‡•§');
        return;
      }

      // If user mentions specific nutrient words, map first found number to it
      if((lower.includes('‡§®‡§æ‡§á‡§ü‡•ç‡§∞‡•ã‡§ú‡§®') || lower.includes('nitrogen') || /\b‡§è‡§®\b/.test(lower)) && nums.length>=1){
        nVal.value = nums[0];
        voiceStatusEl.textContent = 'Nitrogen set to ' + nums[0];
        speakText('‡§®‡§æ‡§á‡§ü‡•ç‡§∞‡•ã‡§ú‡§® ‡§∏‡•á‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ: ' + nums[0]);
        return;
      }
      if((lower.includes('‡§´‡•â‡§∏‡•ç‡§´‡•ã‡§∞‡§∏') || lower.includes('phosphorus') || lower.includes('‡§´‡•â‡§∏‡•ç‡§´‡•ã') || /\b‡§™‡•Ä\b/.test(lower)) && nums.length>=1){
        pVal.value = nums[0];
        voiceStatusEl.textContent = 'Phosphorus set to ' + nums[0];
        speakText('‡§´‡•â‡§∏‡•ç‡§´‡•ã‡§∞‡§∏ ‡§∏‡•á‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ: ' + nums[0]);
        return;
      }
      if((lower.includes('‡§™‡•ã‡§ü‡§æ‡§∂') || lower.includes('potash') || lower.includes('potassium') || /\b‡§ï‡•á\b/.test(lower)) && nums.length>=1){
        kVal.value = nums[0];
        voiceStatusEl.textContent = 'Potassium set to ' + nums[0];
        speakText('‡§™‡•ã‡§ü‡§æ‡§∂ ‡§∏‡•á‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ: ' + nums[0]);
        return;
      }
      if(lower.includes('‡§™‡•Ä‡§è‡§ö') || lower.includes('ph') || lower.includes('pH')){
        // pH might be a decimal
        const num = extractNumbersFromText(lower)[0];
        if(num){ phVal.value = num; voiceStatusEl.textContent = 'pH set to ' + num; speakText('‡§™‡•Ä‡§è‡§ö ‡§∏‡•á‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ: ' + num); return; }
      }

      // If user asks for suggestions / analyze
      const analyzeKeywords = ['analyze','analyse','‡§∏‡•Å‡§ù‡§æ‡§µ','‡§∏‡•Å‡§ù‡§æ‡§µ ‡§¶‡•ã','‡§¨‡§§‡§æ‡§ì','‡§ï‡•å‡§® ‡§∏‡•Ä ‡§´‡§∏‡§≤','‡§ï‡•å‡§® ‡§´‡§∏‡§≤','‡§Ö‡§®‡§æ‡§≤‡§æ‡§á‡§ú‡§º','‡§∏‡•Å‡§ù‡§æ‡§è'];
      if(analyzeKeywords.some(k => lower.includes(k))){
        voiceStatusEl.textContent = 'Running analysis...';
        analyze();
        return;
      }

      // fallback: echo and hint
      speakText('‡§Æ‡•à‡§Ç‡§®‡•á ‡§∏‡•Å‡§®‡§æ: ' + text + '. ‡§Ü‡§™ ‡§ï‡§π ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç, ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§ï‡•á ‡§≤‡§ø‡§è: \"‡§®‡§æ‡§á‡§ü‡•ç‡§∞‡•ã‡§ú‡§® 40\" ‡§Ø‡§æ \"‡§ï‡•å‡§® ‡§∏‡•Ä ‡§´‡§∏‡§≤\"‡•§');
    }

    /* ============================
       Helpful: ensure voices loaded for TTS
       ============================ */
    // Some browsers populate voices asynchronously
    if(typeof speechSynthesis !== 'undefined'){
      speechSynthesis.onvoiceschanged = () => { /* no-op: ensures voices populated */ };
    }

    // initial analyze so UI is populated
    analyze();

    /* ============================
       Notes for integration:
       - Replace the mock datasets with real APIs.
       - To call a backend recommendation service, call fetch('/api/recommend', {...}) inside analyze().
       - For production: use fallback strategies (server-side ASR for languages or use a mobile app SDK) for better ASR in rural devices.
       ============================ */
  </script>
</body>
</html>

